blueprint:
  name: THZSmartID â†” Alarmo (UID persistants & options avancÃ©es)
  description: >
    Ce blueprint permet d'intÃ©grer un lecteur THZSmartID avec le systÃ¨me d'alarme Alarmo de Home Assistant, en offrant une gestion avancÃ©e des accÃ¨s par badge RFID :
      - Synchronisation automatique de l'Ã©tat de l'alarme (armÃ©, dÃ©sarmÃ©, partiel, armement en cours) avec le lecteur.
      - Validation des badges : seuls les UIDs prÃ©sents dans la liste autorisÃ©e (input_text) peuvent armer/dÃ©sarmer l'alarme.
      - Mode ajout/suppression : activez ce mode pour ajouter ou retirer dynamiquement des UIDs autorisÃ©s par simple scan de badge.
      - Retour d'information visuel sur le lecteur (ACCEPTED, REFUSED, ARMING, ARMED, DISARMED, PARTIAL).
      - Gestion des sons de validation ou de refus selon vos prÃ©fÃ©rences.
      - Temporisation des voyants pour une meilleure expÃ©rience utilisateur.
      - Configuration simple et sÃ©curisÃ©e depuis l'interface Home Assistant.

    Cas d'usage :
      - Gestion des accÃ¨s pour les membres du foyer ou du personnel.
      - Ajout/suppression rapide de badges sans intervention technique.
      - SÃ©curitÃ© renforcÃ©e grÃ¢ce Ã  la validation centralisÃ©e des UIDs.

    Pour utiliser ce blueprint :
      1. SÃ©lectionnez les entitÃ©s requises (capteur UID, input_textUIDs, input_boolean inclusion, select commandes, alarme).
      2. GÃ©rez la liste des UIDs autorisÃ©s directement dans Home Assistant ou via le mode inclusion.
      3. Activez le mode inclusion pour ajouter/retirer des badges par scan.
      4. Profitez d'une intÃ©gration fiable et Ã©volutive entre THZSmartID et Alarmo.

    Version : 1.0 du 01/01/2026 par THED&Co - https://tlongstride.github.io/THZSmartID/

  domain: automation

  input:
    uid_sensor:
      name: Capteur UID du pÃ©riphÃ©rique THZSmartID
      selector:
        entity:
          domain: sensor

    alarm_entity:
      name: EntitÃ© Alarmo
      selector:
        entity:
          domain: alarm_control_panel

    command_entity:
      name: Commandes du pÃ©riphÃ©rique THZSmartID
      selector:
        entity:
          domain: select

    uids_text:
      name: Input_text UID autorisÃ©s
      description: UIDs sÃ©parÃ©s par des virgules
      selector:
        entity:
          domain: input_text

    inclusion_mode:
      name: Mode ajout/suppression UID
      selector:
        entity:
          domain: input_boolean

    arm_mode:
      name: Mode dâ€™armement Ã  lâ€™activation
      default: home
      selector:
        select:
          options:
            - home
            - away

    accepted_sound:
      name: Son validation
      default: ACCEPTED_MUTED
      selector:
        select:
          options:
            - ACCEPTED
            - ACCEPTED_MUTED

    refused_sound:
      name: Son refus
      default: REFUSED_MUTED
      selector:
        select:
          options:
            - REFUSED
            - REFUSED_MUTED

    led_timeout:
      name: DurÃ©e voyants (secondes)
      description: 0 = infini
      default: 5
      selector:
        number:
          min: 0
          max: 180
          unit_of_measurement: s

mode: restart

trigger:
  # Carte prÃ©sentÃ©e
  - platform: state
    entity_id: !input uid_sensor
    to: ~

  # Synchronisation voyants depuis Alarmo
  - platform: state
    entity_id: !input alarm_entity

variables:
  uid_sensor_entity: !input uid_sensor
  alarm_entity: !input alarm_entity
  command_entity: !input command_entity
  uids_text_entity: !input uids_text
  inclusion_mode_entity: !input inclusion_mode
  arm_mode: !input arm_mode
  accepted_sound: !input accepted_sound
  refused_sound: !input refused_sound
  led_timeout: !input led_timeout

  uid: "{{ states(uid_sensor_entity) }}"
  uids_list: >
    {{ states(uids_text_entity)
       .split(',')
       | map('trim')
       | reject('equalto','')
       | list }}

condition:
  - condition: template
    value_template: >
      {{ trigger.entity_id != uid_sensor_entity
         or uid not in ['', 'unknown', 'unavailable', 'None', 'none'] }}

action:
  - choose:

      ####################################################
      # ðŸ” SYNC VOYANTS â† Ã‰TAT ALARMO
      ####################################################
      - conditions: "{{ trigger.entity_id == alarm_entity }}"
        sequence:
          - choose:
              - conditions: "{{ is_state(alarm_entity, 'disarmed') }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "DISARMED"

              - conditions: "{{ is_state(alarm_entity, 'armed_away') }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "ARMED"

              - conditions: "{{ is_state(alarm_entity, 'armed_home') or is_state(alarm_entity, 'armed_night') }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "PARTIAL"

              - conditions: "{{ is_state(alarm_entity, 'arming') }}"
                sequence:
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "ARMING"
          # â±ï¸ Extinction voyants aprÃ¨s synchronisation HA
          - choose:
              - conditions: "{{ led_timeout | int > 0 and not is_state(alarm_entity, 'arming') }}"
                sequence:
                  - delay:
                      seconds: "{{ led_timeout | int }}"
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "OFF"

      ####################################################
      # âž•âž– MODE INCLUSION
      ####################################################
      - conditions: "{{ is_state(inclusion_mode_entity, 'on') }}"
        sequence:
          - service: input_text.set_value
            data:
              entity_id: "{{ uids_text_entity }}"
              value: >
                {% if uid in uids_list %}
                  {{ uids_list | reject('equalto', uid) | join(',') }}
                {% else %}
                  {{ (uids_list + [uid]) | join(',') }}
                {% endif %}
          - stop: "UID ajoutÃ© ou retirÃ© (mode inclusion)"

      ####################################################
      # âœ… CARTE VALIDE
      ####################################################
      - conditions: "{{ uid in uids_list }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: "{{ command_entity }}"
            data:
              option: "{{ accepted_sound }}"

          - choose:
              # Armement
              - conditions: "{{ is_state(alarm_entity, 'disarmed') }}"
                sequence:
                  - service: >
                      alarm_control_panel.alarm_arm_{{ 'away' if arm_mode == 'away' else 'home' }}
                    target:
                      entity_id: "{{ alarm_entity }}"

              # DÃ©sarmement
              - conditions: "{{ not is_state(alarm_entity, 'disarmed') }}"
                sequence:
                  - service: alarm_control_panel.alarm_disarm
                    target:
                      entity_id: "{{ alarm_entity }}"

          # Extinction voyants temporisÃ©e
          - choose:
              - conditions: "{{ led_timeout | int > 0 }}"
                sequence:
                  - delay:
                      seconds: "{{ led_timeout | int }}"
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "OFF"

      ####################################################
      # âŒ CARTE INVALIDE
      ####################################################
      - conditions: "{{ uid not in uids_list }}"
        sequence:
          - service: select.select_option
            target:
              entity_id: "{{ command_entity }}"
            data:
              option: "{{ refused_sound }}"

          - choose:
              - conditions: "{{ led_timeout | int > 0 }}"
                sequence:
                  - delay:
                      seconds: "{{ led_timeout | int }}"
                  - service: select.select_option
                    target:
                      entity_id: "{{ command_entity }}"
                    data:
                      option: "OFF"
